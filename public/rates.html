<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PisoWiFi - Rates</title>
    <!-- External links commented out to prevent black screen/loading hang when offline -->
    <!-- <link rel="preconnect" href="https://fonts.googleapis.com"> -->
    <!-- <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> -->
    <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"> -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"> -->
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Modern font */
            background: linear-gradient(135deg, #6dd5ed, #2193b0); /* Vibrant gradient background */
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px 0;
            color: #333;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.98); /* Slightly more opaque */
            backdrop-filter: blur(15px); /* Stronger blur */
            padding: 2.5rem 2rem; /* More vertical padding */
            border-radius: 28px; /* Softer corners */
            box-shadow: 0 25px 50px rgba(0,0,0,0.2); /* Deeper shadow */
            text-align: center;
            width: 90%;
            max-width: 420px; /* Slightly wider */
            display: flex;
            flex-direction: column;
            z-index: 10;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.6); /* Lighter border */
            overflow: hidden; /* For background effects */
        }
        .container::before { /* Subtle background pattern */
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.1), transparent 70%);
            opacity: 0.7;
            pointer-events: none;
            z-index: -1;
        }
        h1 {
            color: #007bff; /* Primary blue */
            margin-top: 0.5rem;
            margin-bottom: 1.8rem; /* More space below title */
            font-weight: 900; /* Bolder */
            letter-spacing: -0.8px; /* Tighter spacing */
            font-size: 2.2rem; /* Larger title */
        }
        /* ===== Improved Rates UI ===== */
        .rates {
            margin-top: 1.5rem; /* More space from title */
            text-align: left;
            border-top: 1px solid rgba(0,0,0,0.08); /* Slightly darker border */
            padding-top: 1.5rem; /* More padding */
        }
        .rates-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px; /* Increased gap */
            margin-bottom: 15px; /* Increased margin */
        }
        .rates-title {
            font-size: 1.2rem; /* Larger title */
            font-weight: 800;
            letter-spacing: -0.3px;
            color: #212529; /* Darker text */
        }
        .rates-subtitle {
            font-size: 0.85rem; /* Slightly larger subtitle */
            color: #6c757d; /* Muted grey */
            margin-top: 4px; /* More space */
        }
        .rates-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            font-weight: 800;
            color: #1a73e8;
            background: rgba(26,115,232,0.10);
            border: 1px solid rgba(26,115,232,0.20);
            padding: 8px 10px;
            border-radius: 999px;
            white-space: nowrap;
        }
        .rates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* Responsive grid */
            gap: 15px; /* Increased gap */
        }
        @media (min-width:420px){
            .rates-grid{grid-template-columns:repeat(3,minmax(0,1fr))}
        }
        .rate-card {
            position: relative;
            background: linear-gradient(180deg, #ffffff, #f8f9fa); /* Lighter gradient */
            border: 1px solid rgba(0,0,0,0.1); /* Softer border */
            border-radius: 18px; /* More rounded */
            padding: 15px; /* More padding */
            box-shadow: 0 12px 25px rgba(0,0,0,0.08); /* Deeper shadow */
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            overflow: hidden;
            display: flex; /* Flexbox for internal alignment */
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px; /* Minimum height for cards */
        }
        .rate-card::before {
            content: "";
            position: absolute;
            inset: -2px;
            background: radial-gradient(circle at 20% 20%, rgba(0,123,255,0.25), transparent 55%); /* Blue accent */
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }
        .rate-amount {
            display: flex;
            align-items: baseline;
            gap: 4px; /* Tighter gap */
            font-weight: 900;
            color: #212529; /* Darker text */
            line-height: 1; /* Prevent extra line height */
        }
        .rate-amount .peso {
            font-size: 1rem; /* Larger peso sign */
            opacity: 0.85;
        }
        .rate-amount .value {
            font-size: 2rem; /* Larger value */
            letter-spacing: -0.8px; /* Tighter spacing */
        }
        .rate-time {
            margin-top: 8px; /* More space */
            font-size: 1rem; /* Larger time text */
            font-weight: 700; /* Slightly less bold */
            color: #007bff; /* Primary blue */
            display: flex;
            align-items: center;
            gap: 6px; /* Tighter gap */
        }
        .rate-meta {
            margin-top: 8px; /* More space */
            font-size: 0.8rem; /* Slightly larger meta text */
            color: #6c757d; /* Muted grey */
            display: flex;
            align-items: center;
            gap: 6px; /* Tighter gap */
        }
        .rate-badge {
            position: absolute;
            top: 12px; /* Adjusted position */
            right: 12px; /* Adjusted position */
            font-size: 0.75rem; /* Slightly larger badge */
            font-weight: 900;
            color: #28a745; /* Green color */
            background: rgba(40,167,69,0.15); /* Green background */
            border: 1px solid rgba(40,167,69,0.25); /* Green border */
            padding: 7px 9px; /* More padding */
            border-radius: 999px;
            text-transform: uppercase; /* Uppercase text */
            letter-spacing: 0.5px;
        }
        .rates-loading {
            grid-column: 1/-1;
            text-align: center;
            color: #6c757d; /* Muted grey */
            padding: 20px 15px; /* More padding */
            background: rgba(0,0,0,0.05); /* Slightly darker background */
            border: 1px dashed rgba(0,0,0,0.2); /* Darker dashed border */
            border-radius: 18px; /* More rounded */
            font-size: 1rem;
        }
        
        /* Modal Styles (copied from index.html for consistency) */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #ffffff;
            padding: 2.5rem; /* More padding */
            border-radius: 24px; /* Softer corners */
            text-align: center;
            width: 88%; /* Slightly wider */
            max-width: 350px; /* Slightly wider */
            box-shadow: 0 15px 40px rgba(0,0,0,0.35); /* Deeper shadow */
            animation: modal-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(0,0,0,0.08); /* Subtle border */
        }

        @keyframes modal-pop {
            0% { transform: scale(0.7); opacity: 0; } /* Start smaller */
            100% { transform: scale(1); opacity: 1; }
        }

        .countdown-circle {
            width: 130px; /* Larger circle */
            height: 130px;
            border-radius: 50%;
            border: 10px solid #e0e0e0; /* Lighter border */
            border-top: 10px solid #28a745; /* Vibrant green */
            margin: 1.8rem auto; /* More margin */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.8rem; /* Larger font */
            font-weight: 800; /* Bolder */
            color: #28a745; /* Vibrant green */
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); /* Subtle shadow */
        }

        .countdown-circle:active {
            transform: scale(0.96); /* Slightly less pronounced press */
            background-color: #f5f5f5; /* Lighter background */
        }

        .modal-title {
            font-size: 1.8rem; /* Larger title */
            color: #007bff; /* Primary blue */
            margin-bottom: 0.75rem; /* More space */
            font-weight: 800;
        }

        .modal-text {
            color: #6c757d; /* Muted grey */
            margin-bottom: 1.8rem; /* More space */
            font-size: 1rem;
        }

        .modal-footer {
            display: flex;
            gap: 12px; /* Increased gap */
            margin-top: 1rem; /* More space above footer */
        }

        .done-btn {
            background: linear-gradient(135deg, #28a745, #218838); /* Green gradient */
            color: white;
            border: none;
            padding: 14px 22px; /* More padding */
            border-radius: 12px; /* Softer corners */
            cursor: pointer;
            font-weight: bold;
            flex: 2;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px; /* Increased gap */
            font-size: 1.05rem;
            box-shadow: 0 5px 15px rgba(40,167,69,0.2);
        }

        .done-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #218838, #1e7e34); /* Darker green gradient */
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 8px 20px rgba(40,167,69,0.35); /* Stronger shadow */
        }

        .done-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        .cancel-btn {
            background: #e9ecef; /* Lighter grey */
            color: #495057; /* Darker text */
            border: none;
            padding: 14px 22px; /* More padding */
            border-radius: 12px; /* Softer corners */
            cursor: pointer;
            font-weight: bold;
            flex: 1;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px; /* Increased gap */
            font-size: 1.05rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .cancel-btn:hover {
            background: #dee2e6; /* Darker grey */
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .cancel-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        @keyframes check-bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        .fa-check-circle { animation: check-bounce 2s infinite; }

        @keyframes shake-icon {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        .cancel-btn:hover i {
            animation: shake-icon 0.2s infinite;
        }

        @keyframes blink-red-button {
            0%, 100% { background: linear-gradient(135deg, #e74a3b 0%, #c23b2f 100%); } /* Red */
            50% { background: linear-gradient(135deg, #ff6b5e 0%, #e74a3b 100%); } /* Lighter Red */
        }

        .rate-card.busy {
            animation: blink-red-button 1s infinite alternate;
            cursor: not-allowed;
            pointer-events: none; /* Disable clicks */
        }
        .rate-card.busy .rate-amount,
        .rate-card.busy .rate-time,
        .rate-card.busy .rate-meta {
            color: white !important; /* Ensure text is white on red background */
        }
        .rate-card.busy .rate-amount .peso,
        .rate-card.busy .rate-amount .value {
            color: white !important;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <h1>PisoWiFi Rates</h1>
        <div class="rates">
            <div class="rates-header">
                <div>
                    <div class="rates-title">Available Promos</div>
                </div>
            </div>

            <div id="ratesList" class="rates-grid">
                <div class="rates-loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading rates...
                </div>
            </div>
        </div>
        <button class="cancel-btn" onclick="window.location.href='index.html'" style="margin-top: 1.5rem;">
            <i class="fas fa-arrow-left" style="margin-right: 8px;"></i> Back to Home
        </button>
    </div>

    <!-- Modals for Insert Coin, Voucher, E-Wallet (copied from index.html) -->
    <div id="insertCoinModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-circle-notch fa-spin" style="color: #1a73e8; margin-right: 10px;"></i>
                Insert Coin
            </div>
            <p class="modal-text">Please drop your coins now.</p>
            <div id="promoHint" style="display:none; margin: 0.75rem 0 0; padding: 10px 12px; border-radius: 12px; background: rgba(26,115,232,0.08); border: 1px solid rgba(26,115,232,0.18); color:#1a73e8; font-weight: 700; font-size: 0.9rem;"></div>
            <div id="countdownDisplay" class="countdown-circle" title="Tap to simulate ₱5 coin">60</div>
            <div style="margin-bottom: 1rem; font-weight: bold; color: #1a73e8;">
                Inserted: ₱ <span id="insertedAmount">0.00</span>
            </div>
            <div class="modal-footer">
                <button id="doneBtn" class="done-btn" onclick="handleDone()" disabled>
                    <i class="fas fa-check-circle"></i> DONE
                </button>
                <button id="cancelBtn" class="cancel-btn" onclick="hideInsertCoinModal()">
                    <i class="fas fa-times-circle"></i> CANCEL
                </button>
            </div>
        </div>
    </div>

    <div id="voucherModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-ticket-alt" style="color: #4e73df; margin-right: 10px;"></i>
                Voucher Code
            </div>
            <p class="modal-text">Enter your 6-character voucher code below.</p>
            <input type="text" id="voucherCodeInput" class="voucher-input" placeholder="XXXXXX" maxlength="6">
            <div class="modal-footer">
                <button id="submitVoucherBtn" class="done-btn" style="background: #4e73df;" onclick="handleVoucherSubmit()">
                    <i class="fas fa-check-circle"></i> SUBMIT
                </button>
                <button class="cancel-btn" onclick="hideVoucherModal()">
                    <i class="fas fa-times-circle"></i> CANCEL
                </button>
            </div>
        </div>
    </div>

    <div id="ewalletModal" class="modal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-title">
                <i class="fas fa-wallet" style="color: #00c2ff; margin-right: 10px;"></i>
                E-Wallet Payment
            </div>
            <p class="modal-text">Select a promo to pay via Maya.</p>
            <div id="ewalletRatesList" style="margin-bottom: 1.5rem; text-align: left; max-height: 200px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 10px;">
                <!-- Rates will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="hideEWalletModal()">
                    <i class="fas fa-times-circle"></i> CANCEL
                </button>
            </div>
        </div>
    </div>

    <audio id="insertCoinAudio" src=""></audio>
    <audio id="coinDropAudio" src=""></audio>
    <audio id="salamatAudio" src=""></audio>
    <audio id="countdownTickAudio" src=""></audio> <!-- New audio element for countdown tick -->

    <script>
        let countdownInterval;
        let coinCheckInterval;
        let countdownValue = 60;
        let currentCount = 60;
        let totalInserted = 0;
        let audioCtx;
        let selectedRate = null;
        let countdownTickAudioEl; // Declare variable for countdown tick audio
        let clientMacAddress = null; // Store client's MAC address
        let socket; // Socket.IO client instance

        // Function to get client MAC address and initialize socket
        async function initializeClient() {
            try {
                const response = await fetch('/api/client-info');
                const data = await response.json();
                clientMacAddress = data.mac;
                console.log('Client MAC Address:', clientMacAddress);

                // Initialize Socket.IO after getting MAC address
                if (clientMacAddress) {
                    socket = io({ query: { mac: clientMacAddress } });

                    socket.on('connect', () => {
                        console.log('Socket connected, requesting coin insertion status.');
                        socket.emit('requestCoinInsertionStatus'); // Request current status on connect
                    });

                    socket.on('coinInsertionStatus', (status) => {
                        const rateCards = document.querySelectorAll('.rate-card');
                        rateCards.forEach(card => {
                            if (status.active && status.by !== clientMacAddress) {
                                card.classList.add('busy');
                                card.innerHTML = '<div style="color:white; font-weight:bold; font-size:1.1rem; display:flex; align-items:center; justify-content:center; height:100%;"><i class="fas fa-hourglass-half" style="margin-right: 10px;"></i> WAIT LANG PO MAY NAGHUHULOG NA IBANG USER</div>';
                            } else {
                                card.classList.remove('busy');
                                // Only re-render if dataset.rate exists, otherwise let fetchConfig handle it
                                if (card.dataset.rate) {
                                    const rate = JSON.parse(card.dataset.rate);
                                    const unitDisplay = rate.duration > 1 ? (rate.unit.endsWith('s') ? rate.unit : rate.unit + 's') : rate.unit;
                                    card.innerHTML = '<div class="rate-amount"><span class="peso">₱</span><span class="value">' + rate.amount + '</span></div><div class="rate-time"><i class="fas fa-clock"></i><span>' + rate.duration + ' ' + unitDisplay + '</span></div><div class="rate-meta"><i class="fas fa-hand-pointer"></i><span></span></div>';
                                }
                            }
                        });
                    });
                }
            } catch (e) {
                console.error("Failed to get client info or initialize socket:", e);
            }
        }

        initializeClient(); // Call on page load

        function selectRateAndOpen(rate) {
            // Removed functionality to open modal on rate card click
            return;
        }

        function initAudio() {
            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    console.log("AudioContext initialized");
                }
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume().then(() => console.log("AudioContext resumed"));
                }
            } catch (e) {
                console.error("AudioContext initialization failed:", e);
            }
        }

        // Initialize audio on any click to satisfy browser policies
        window.addEventListener('click', initAudio, { once: true });

        async function showInsertCoinModal() {
            initAudio();
            const modal = document.getElementById('insertCoinModal');
            const display = document.getElementById('countdownDisplay');
            const audio = document.getElementById('insertCoinAudio');
            const doneBtn = document.getElementById('doneBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const insertedAmountEl = document.getElementById('insertedAmount');
            
            modal.style.display = 'flex';
            const promoHint = document.getElementById('promoHint');
            if (promoHint && !selectedRate) { promoHint.style.display = 'none'; promoHint.innerHTML = ''; }
            
            // Initialize with current server amount to avoid playing sound for old coins
            try {
                const response = await fetch('/api/current-coins');
                const data = await response.json();
                totalInserted = data.amount || 0;
            } catch (e) {
                totalInserted = 0;
            }

            insertedAmountEl.innerText = totalInserted.toFixed(2);
            doneBtn.disabled = totalInserted <= 0;
            cancelBtn.disabled = totalInserted > 0;
            
            // Reset and start countdown
            currentCount = countdownValue;
            display.innerText = currentCount;
            display.style.borderColor = '#f3f3f3';
            display.style.color = '#34a853';

            if (audio.src) {
                audio.play().catch(e => console.error("Audio play failed:", e));
            }

            clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                currentCount--;
                display.innerText = currentCount;

                // Visual feedback for low time
                if (currentCount <= 10) {
                    display.style.color = '#ea4335';
                    display.style.borderTopColor = '#ea4335';
                }

                // Play countdown tick sound
                if (countdownTickAudioEl && countdownTickAudioEl.src) {
                    countdownTickAudioEl.currentTime = 0;
                    countdownTickAudioEl.play().catch(e => console.warn("Countdown tick audio play failed:", e));
                }

                // Visual feedback for low time
                if (currentCount <= 10) {
                    display.style.color = '#ea4335';
                    display.style.borderTopColor = '#ea4335';
                }

                if (currentCount <= 0) {
                    hideInsertCoinModal();
                }
            }, 1000);

            // Emit startCoinInsertion event
            if (socket && clientMacAddress) {
                socket.emit('startCoinInsertion', { mac: clientMacAddress });
            }

            // Start polling for coins
            startCoinPolling();
        }

        function startCoinPolling() {
            clearInterval(coinCheckInterval);
            coinCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/current-coins');
                    const data = await response.json();
                    
                    if (data.amount > totalInserted) {
                        totalInserted = data.amount;
                        document.getElementById('insertedAmount').innerText = totalInserted.toFixed(2);
                        document.getElementById('doneBtn').disabled = false;
                        document.getElementById('cancelBtn').disabled = true;
                        
                        // Reset countdown on coin insertion
                        currentCount = countdownValue;
                        const display = document.getElementById('countdownDisplay');
                        display.innerText = currentCount;
                        display.style.color = '#34a853';
                        display.style.borderTopColor = '#34a853';
                        
                        playCoinClink();
                    } else if (data.amount < totalInserted) {
                        // Handle case where coins were reset elsewhere
                        totalInserted = data.amount;
                        document.getElementById('insertedAmount').innerText = totalInserted.toFixed(2);
                    }
                } catch (e) {
                    console.error("Coin polling error:", e);
                }
            }, 500); // Increased polling frequency for better responsiveness
        }

        async function handleDone() {
            const salamatAudio = document.getElementById('salamatAudio');
            salamatAudio.play().catch(e => console.error("Salamat audio play failed:", e));
            
            const doneBtn = document.getElementById('doneBtn');
            doneBtn.disabled = true;
            doneBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ACTIVATING...';

            try {
                const response = await fetch('/api/use-time', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    setTimeout(() => {
                        hideInsertCoinModal();
                        // checkUserStatus(); // Refresh status - not needed on rates page
                        alert(`Success! ${data.minutesAdded} minutes added.`);
                    }, 2000);
                } else {
                    alert(data.error || 'Failed to activate time.');
                    doneBtn.disabled = false;
                    doneBtn.innerHTML = '<i class="fas fa-check-circle"></i> DONE';
                }
            } catch (e) {
                console.error("Use time error:", e);
                alert('Connection error.');
                doneBtn.disabled = false;
                doneBtn.innerHTML = '<i class="fas fa-check-circle"></i> DONE';
            } finally {
                // Emit endCoinInsertion event
                if (socket && clientMacAddress) {
                    socket.emit('endCoinInsertion', { mac: clientMacAddress });
                }
            }
        }

        function hideInsertCoinModal() {
            const modal = document.getElementById('insertCoinModal');
            modal.style.display = 'none';
            clearInterval(countdownInterval);
            clearInterval(coinCheckInterval);
            
            const audio = document.getElementById('insertCoinAudio');
            audio.pause();
            audio.currentTime = 0;
            selectedRate = null;
            const promoHint = document.getElementById('promoHint');
            if (promoHint) { promoHint.style.display = 'none'; promoHint.innerHTML = ''; }

            // Emit endCoinInsertion event if it was active
            if (socket && clientMacAddress) {
                socket.emit('endCoinInsertion', { mac: clientMacAddress });
            }
        }

        function showVoucherModal() {
            document.getElementById('voucherModal').style.display = 'flex';
            document.getElementById('voucherCodeInput').value = '';
            document.getElementById('voucherCodeInput').focus();
        }

        function hideVoucherModal() {
            document.getElementById('voucherModal').style.display = 'none';
        }

        function showEWalletModal() {
            const modal = document.getElementById('ewalletModal');
            const ratesList = document.getElementById('ewalletRatesList');
            modal.style.display = 'flex';
            const promoHint = document.getElementById('promoHint');
            if (promoHint && !selectedRate) { promoHint.style.display = 'none'; promoHint.innerHTML = ''; }
            
            // Load rates into the modal
            fetch('/api/config')
                .then(res => res.json())
                .then(config => {
                    ratesList.innerHTML = '';
                    if (!config.rates || config.rates.length === 0) {
                        ratesList.innerHTML = '<div style="text-align: center; color: #888;">No rates available</div>';
                        return;
                    }

                    config.rates.forEach(rate => {
                        const btn = document.createElement('button');
                        btn.className = 'insert-coin-btn';
                        btn.style.fontSize = '1rem';
                        btn.style.padding = '10px';
                        btn.style.marginBottom = '8px';
                        btn.style.background = 'linear-gradient(135deg, #4e73df 0%, #224abe 100%)';
                        
                        const unitDisplay = rate.duration > 1 ? (rate.unit.endsWith('s') ? rate.unit : rate.unit + 's') : rate.unit;
                        btn.innerHTML = `<i class="fas fa-shopping-cart"></i> ₱${rate.amount} - ${rate.duration} ${unitDisplay}`;
                        
                        btn.onclick = () => initiateMayaCheckout(rate);
                        ratesList.appendChild(btn);
                    });
                });
        }

        function hideEWalletModal() {
            document.getElementById('ewalletModal').style.display = 'none';
        }

        async function initiateMayaCheckout(rate) {
            const ewalletModal = document.getElementById('ewalletModal');
            const ratesList = document.getElementById('ewalletRatesList');
            const originalContent = ratesList.innerHTML;
            
            ratesList.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin fa-2x" style="color: #4e73df;"></i><p>Redirecting to Maya...</p></div>';

            try {
                // Get client info first to ensure we have the MAC
                const infoRes = await fetch('/api/client-info');
                const info = await infoRes.json();
                
                if (!info.mac || info.mac === "00:00:00:00:00:00") {
                    alert("Could not detect your device MAC address. Please ensure you are connected to the WiFi.");
                    ratesList.innerHTML = originalContent;
                    return;
                }

                const response = await fetch('/api/maya/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: rate.amount,
                        duration: rate.duration,
                        unit: rate.unit,
                        mac: info.mac
                    })
                });

                const data = await response.json();
                if (data.checkoutUrl) {
                    window.location.href = data.checkoutUrl;
                } else {
                    alert(data.error || "Failed to initiate checkout.");
                    ratesList.innerHTML = originalContent;
                }
            } catch (e) {
                console.error("Checkout error:", e);
                alert("Connection error.");
                ratesList.innerHTML = originalContent;
            }
        }

        async function handleVoucherSubmit() {
            const codeInput = document.getElementById('voucherCodeInput');
            const code = codeInput.value.trim().toUpperCase();
            const submitBtn = document.getElementById('submitVoucherBtn');

            if (!code) {
                alert('Please enter a voucher code.');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> VERIFYING...';

            try {
                const response = await fetch('/api/use-voucher', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const data = await response.json();

                if (data.success) {
                    const salamatAudio = document.getElementById('salamatAudio');
                    salamatAudio.play().catch(e => console.error("Salamat audio play failed:", e));
                    
                    setTimeout(() => {
                        hideVoucherModal();
                        // checkUserStatus(); // Refresh status - not needed on rates page
                        alert(`Success! ${data.minutesAdded} minutes added.`);
                    }, 1000);
                } else {
                    alert(data.error || 'Invalid voucher code.');
                }
            } catch (e) {
                console.error("Voucher error:", e);
                alert('Connection error.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> SUBMIT';
            }
        }

        // Function to play the coin clink sound
        function playCoinClink() {
            const coinAudio = document.getElementById('coinDropAudio');
            if (coinAudio) {
                coinAudio.currentTime = 0;
                coinAudio.play().catch(e => {
                    console.warn("Audio file playback failed, falling back to synthesis:", e);
                    playSynthesizedCoinClink();
                });
            } else {
                playSynthesizedCoinClink();
            }
        }

        function playSynthesizedCoinClink() {
            initAudio();
            if (!audioCtx) return;

            try {
                const t = audioCtx.currentTime;
                const osc1 = audioCtx.createOscillator();
                const gain1 = audioCtx.createGain();
                osc1.type = 'sine';
                osc1.frequency.setValueAtTime(3500, t);
                osc1.frequency.exponentialRampToValueAtTime(2500, t + 0.05);
                gain1.gain.setValueAtTime(0.4, t);
                gain1.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
                osc1.connect(gain1);
                gain1.connect(audioCtx.destination);
                osc1.start(t);
                osc1.stop(t + 0.2);
            } catch (e) {
                console.error("Synthesis failed:", e);
            }
        }

        // Function to simulate coin insertion (for testing/mobile)
        async function simulateCoinTap() {
            const amount = 5;
            try {
                await fetch('/api/insert-coin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount })
                });
                console.log(`Simulated tap insertion: ₱${amount}`);
                
                // Play synthesized coin sound
                playCoinClink();
            } catch (err) {
                console.error('Simulation error:', err);
            }
        }

        // Coin Simulation using Arrow Keys
        window.addEventListener('keydown', async (e) => {
            const modal = document.getElementById('insertCoinModal');
            if (modal.style.display !== 'flex') return;

            let amount = 0;
            switch(e.key) {
                case 'ArrowUp': amount = 1; break;
                case 'ArrowDown': amount = 5; break;
                case 'ArrowLeft': amount = 10; break;
                case 'ArrowRight': amount = 20; break;
                default: return;
            }

            if (amount > 0) {
                try {
                    await fetch('/api/insert-coin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ amount })
                    });
                    console.log(`Simulated insertion: ₱${amount}`);
                    
                    // Play synthesized coin sound
                    playCoinClink();
                } catch (err) {
                    console.error('Simulation error:', err);
                }
            }
        });

        async function fetchConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                // Apply Audio
                const audioEl = document.getElementById('insertCoinAudio');
                if (config.insert_coin_audio) {
                    audioEl.src = config.insert_coin_audio;
                }

                const coinAudioEl = document.getElementById('coinDropAudio');
                if (config.coin_drop_audio) {
                    coinAudioEl.src = config.coin_drop_audio;
                } else {
                    coinAudioEl.src = '/media/coins.wav';
                }

                const salamatAudioEl = document.getElementById('salamatAudio');
                if (config.salamat_audio) {
                    salamatAudioEl.src = config.salamat_audio;
                } else {
                    salamatAudioEl.src = '/media/Salamat .mp3';
                }

                // Apply Countdown Tick Audio
                countdownTickAudioEl = document.getElementById('countdownTickAudio');
                if (config.countdown_tick_audio) {
                    countdownTickAudioEl.src = config.countdown_tick_audio;
                } else {
                    countdownTickAudioEl.src = ''; // No default, so it remains empty if not set
                }

                // Apply Countdown Setting
                if (config.insert_coin_countdown) {
                    countdownValue = parseInt(config.insert_coin_countdown);
                    document.getElementById('countdownDisplay').innerText = countdownValue;
                }

                const ratesList = document.getElementById('ratesList');
                ratesList.innerHTML = '';

                if (!config.rates || config.rates.length === 0) {
                    ratesList.innerHTML = '<div class="rates-loading">No rates available</div>';
                    return;
                }

                const toMinutes = (duration, unit) => {
                    let mins = parseInt(duration, 10) || 0;
                    const u = (unit || '').toLowerCase();
                    if (u === 'hour' || u === 'hours') mins *= 60;
                    else if (u === 'day' || u === 'days') mins *= 1440;
                    return mins;
                };

                const withComputed = config.rates.map(r => {
                    const mins = toMinutes(r.duration, r.unit);
                    const amount = parseFloat(r.amount) || 0;
                    const ratio = amount > 0 ? (mins / amount) : 0;
                    return { ...r, mins, ratio };
                });

                const best = withComputed.reduce((acc, cur) => (cur.ratio > acc.ratio ? cur : acc), withComputed[0]);

                withComputed.forEach(rate => {
                    const card = document.createElement('div');
                    card.className = 'rate-card';

                    const unitDisplay = rate.duration > 1 ? (rate.unit.endsWith('s') ? rate.unit : rate.unit + 's') : rate.unit;

                    const isBest = best && rate.amount === best.amount && rate.duration === best.duration && rate.unit === best.unit;
                    if (isBest) {
                        // Removed "Best Value" badge as per user request
                    }

                    card.innerHTML += '<div class="rate-amount"><span class="peso">₱</span><span class="value">' + rate.amount + '</span></div><div class="rate-time"><i class="fas fa-clock"></i><span>' + rate.duration + ' ' + unitDisplay + '</span></div><div class="rate-meta"><i class="fas fa-hand-pointer"></i><span></span></div>';
                    card.dataset.rate = JSON.stringify(rate); // Store rate data for re-rendering

                    ratesList.appendChild(card);
                });

                // After rendering, check current coin insertion status and update buttons
                if (socket && clientMacAddress) {
                    socket.emit('requestCoinInsertionStatus'); // Request current status
                }

            } catch (error) {
                console.error('Error fetching config:', error);
                document.getElementById('ratesList').innerHTML = '<div class="rates-loading" style="color: red;">Error loading rates: ' + error.message + '</div>';
            }
        }

        fetchConfig();
    </script>
</body>
</html>
